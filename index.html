<html>

<head>
	<title>Wage Mobility Interactive</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.4.1/snap.svg-min.js"></script>
	<!-- <link href="css/materialdesignicons.min.css" media="all" rel="stylesheet" type="text/css" /> -->

	<style>
		@import url(https://fonts.googleapis.com/css?family=Lato:400,700);
		.subconstraint{max-width:1045px;}
		.graph{max-width:1045px}
		.hed{font-family:'Lato';font-size:22px;font-weight:700;}
		.dek{font-family:'Lato';font-size:17px;margin-bottom:20px;}
	</style>

	<script>
		// design for 1045 pixels, switch to a 'tall' format if fewer than 1045 pixels are available
		if(window.outerWidth>900){
			wide=1
		} else{
			wide=0
		}

	</script>

</head>

<body>
	
	<div class='subconstraint'>
		<div class='hed'>Income mobility blah blah blah</div>
		<div class='dek'>Each block represents a 1 </div>
		<div class='styled-select'>
			<span class='select_carat'>
				<select name="select" onchange='demo_change()' id='demo_select'>
					<option value=0>All</option> 
					<option value=1 selected>Female</option>
					<option value=2>Male</option>
				</select>
			</span>
		</div>
	</div>

	<div class='subconstraint'>
		<svg id="income_graph" viewbox='0,0,1045,700' ></svg>
	</div>

</body>

<script defer>
var data = {'All':{'pre':{1:[23.87,19.61,15.96,12.3,9.52,6.68,4.62,3.73,2.16,1.56],2:[17.35,17.86,16.5,13.52,10.55,8.43,6.06,4.53,2.86,2.34],3:[11.85,14.07,16.62,15.25,12.79,9.78,7.46,5.5,3.87,2.81],4:[8.61,10.71,13.03,15.49,14.25,12.09,9.99,7.29,5.21,3.33],5:[6.35,7.98,10.23,13.01,14.79,14.61,12.34,9.29,6.82,4.57],6:[5.13,5.8,7.67,9.71,12.63,14.88,15.32,13.32,9.71,5.84],7:[3.68,4.6,5.6,7.3,9.22,13.08,16.16,17.21,14.31,8.84],8:[2.71,3.26,4.18,5.04,6.46,9.67,14.89,19.74,20.47,13.58],9:[2.03,2.32,2.7,3.74,4.3,6.44,9.56,17.32,25.52,26.08],10:[1.68,1.99,2.02,2.39,2.97,3.57,4.89,8.12,18.42,53.95]},'post':{1:[26.13,21.25,16.8,11.89,7.96,5.66,3.9,2.94,2.01,1.45],2:[19.1,19.09,17.46,14.47,10.22,7.03,4.97,3.43,2.51,1.72],3:[12.98,15.03,17.03,16.33,12.86,8.8,6.5,4.68,3.4,2.38],4:[9.51,11.33,14.32,16.65,15.2,11.75,8.16,6.16,4.23,2.69],5:[6.84,8.08,10.59,13.83,16.42,14.97,11.68,8.41,5.53,3.64],6:[5.43,5.9,7.75,10.5,14.16,16.52,15.05,12.16,8.13,4.4],7:[4.26,4.94,6.2,7.75,10.29,14.63,17.56,16.29,11.52,6.56],8:[3.34,3.6,4.26,5.3,6.93,10.42,15.79,21.19,18.83,10.33],9:[2.4,2.74,3.01,3.74,4.52,6.1,9.73,17.41,27.68,22.68],10:[1.73,1.61,1.7,2.1,2.52,3.14,4.26,7.25,17.11,58.58]},'difference':{1:[9.46,8.37,5.28,-3.27,-16.38,-15.21,-21.11,-6.61,-7.45],2:[10.06,6.89,5.82,7,-3.07,-16.65,-17.92,-24.19,-12.25,-26.6],3:[9.54,6.83,2.52,7.07,0.49,-9.97,-12.88,-14.84,-12.2,-15.25],4:[10.43,5.77,9.93,7.5,6.69,-2.86,-18.36,-15.47,-18.75,-19.17],5:[7.7,1.22,3.59,6.28,11.04,2.46,-5.35,-9.49,-18.85,-20.44],6:[5.77,1.59,1.11,8.19,12.12,11.04,-1.77,-8.68,-16.26,-24.57],7:[15.85,7.37,10.66,6.2,11.6,11.8,8.65,-5.34,-19.48,-25.75],8:[23.42,10.29,1.91,5.26,7.29,7.76,6.03,7.34,-7.98,-23.92],9:[18.16,18.45,11.56,-0.22,5.06,-5.32,1.79,.5,8.46,-13.01],10:[2.89,-19.14,-15.7,-11.99,-15.22,-12.2,-12.85,-10.71,-7.1,8.58]}}}

var mobile = Snap('#income_graph')
var color_scale = ['#67c2a5','#fc8d62']
var width=950
var left_margin=0
var type='pre'

// issue commands
draw_base()
draw_graph(data['All'][type])

function draw_base(){
	var arrow = mobile.path('M0,0 L0,4 L6,2 L0,0').attr({fill:'#ccc'})
	var arrow2 = mobile.path('M6,0 L6,4 L0,2 L6,0').attr({fill:'#ccc'})
	var amarker = arrow.marker(0,0,6,4,0,2).attr({});
	var amarker2 = arrow2.marker(0,0,6,4,6,2).attr({});

	var rich_end = mobile.text(width-1,69,['Richer after','15 years']).attr({'font-family':'Lato','text-anchor':'middle'})
	rich_end.selectAll("tspan:not(:first-child)").attr({x:rich_end.attr('x'),dy:15})
	var poor_end = mobile.text(width,625,['Poorer after','15 years']).attr({'font-family':'Lato','text-anchor':'middle'})
	poor_end.selectAll("tspan:not(:first-child)").attr({x:poor_end.attr('x'),dy:15})
	var stay_same = mobile.text(width+4,348,['No change','in income']).attr({'font-family':'Lato','text-anchor':'start'})
	stay_same.selectAll("tspan:not(:first-child)").attr({x:parseInt(stay_same.attr('x')),dy:15})

	// grid lines
	var percents=[10,20,30,40,50,60,70]
	for (var i=0;i<percents.length;i++){
		mobile.line(left_margin,335-size_rect(percents[i]),left_margin+width,335-size_rect(percents[i])).attr({stroke:'#eee','stroke-width':1,'shape-rendering':'crispEdges'})
		mobile.line(left_margin,365+size_rect(percents[i]),left_margin+width,365+size_rect(percents[i])).attr({stroke:'#eee','stroke-width':1,'shape-rendering':'crispEdges'})
		mobile.text(left_margin+width+4,4+335-size_rect(percents[i]),percents[i]+'%').attr({'font-family':'Lato',fill:'#aaa','font-size':13})
		mobile.text(left_margin+width+4,4+365+size_rect(percents[i]),percents[i]+'%').attr({'font-family':'Lato',fill:'#aaa','font-size':13})
	}

	var guideline = mobile.line(width-1,100,width-1,600).attr({'stroke-width':1,'stroke':'#ccc','shape-rendering':'crispEdges','marker-end':amarker,'marker-start':amarker2})
}

function switch_graph(newtype){
	type=newtype
	var matrix=data['All'][type]
	for(var i=1;i<11;i++){
		for(var j=0;j<10;j++){
			if(i!=j+1){
				var temp=mobile.select("rect[starting='"+i+"'][ending='"+(j+1)+"']")
				var value=matrix[i][j]
				temp.animate({height:size_rect(value)},800)
			} else {
				var value=matrix[i][j]
				var temp=mobile.select("rect[starting='"+i+"'][ending='"+(j+1)+"']")
				var temptext=mobile.select("text[starting='"+i+"'][ending='"+(j+1)+"']").attr({text:value.toFixed()+'%'})
			}
		}
	}
}

function draw_graph(matrix){
	// 0 to 1000, 10 pixel gutter on left side, 1 pixel margins between
	var gap=1
	var total=width-left_margin-10*gap
	var bin_width=total/10
	var midg=mobile.gradient("l(0,0,0,1)#67c2a5-#fc8d62")

	for(var i=1;i<11;i++){
		// i is is the starting percentile bucket
		rect_top=0
		for(var j=0;j<10;j++){
			// j is the ending percentile bucket (starts at 0 because this is just an indexed array)
			// draw all rectangles starting at bottom and working up
			// then shift all rectangle up so that the i-1 rectangle is centered around 350
			var size=size_rect(matrix[i][j])

			// get appropriate fill
			if(i==j+1){
				var fill=choose_gray_scale(matrix[i][j])
				var opacity=1
				size=30
			} else if(i<j+1){
				var fill=color_scale[0]
				var opacity=.7
			} else{
				var fill=color_scale[1]
				var opacity=.7
			}
			if(j!=0){rect_top=rect_top-size-1}

			var base_bin=mobile.rect(left_margin+bin_width*(i-1)+gap*(i-1),rect_top,bin_width,size).attr({basex:left_margin+bin_width*(i-1)+gap*(i-1),fill:fill,'shape-rendering':'crispEdges',starting:i,ending:j+1,'stroke-width':0,'stroke':'#888',opacity:opacity})
			if(i==j+1){
				var text_overlay=mobile.text(bin_width/2+left_margin+bin_width*(i-1)+gap*(i-1),rect_top+37,matrix[i][j].toFixed()+'%').attr({fill:'white',starting:i,ending:j+1,'font-family':'Lato','text-anchor':'middle'})
			}
		}

		// find x coord of the rect that has starting=i and ending=i
		var base=mobile.select("rect[starting='"+i+"'][ending='"+i+"']")
		var coords=base.getBBox()
		var offset=350-(coords.y+coords.height/2)

		mobile.selectAll("[starting='"+i+"']").forEach(function(step,i){
			var steploc=step.getBBox().y
			step.attr({y:steploc+offset,basey:steploc+offset})
		})

		// transparent overlay for hover effects
		var overlay=mobile.rect(left_margin+bin_width*(i-1)+gap*(i-1),50,bin_width,650).attr({opacity:0,starting:i})
		overlay.hover(expand_block,reduce_block)
	}
}

function choose_gray_scale(value){
	if(value<19){return '#999'}
	if(value>=19 && value<22){return '#777'}
	if(value>=22 && value<30){return '#555'}
	if(value>=30){return '#222'}
}

function size_rect(value){
	// value to size a rectangle vertically based on the value it represents
	var max=60
	var min=0

	// max height is the largest a bin can be (vertically) based on data value
	// since the max value is 60, and there are 300 pixels of vertical real-
	// estate available, the largest bin can be 60% of those 300 pixels. Scale
	// everything else accordingly.
	var max_height=300*.6

	return (max_height*value/(max-min))-1
}

function expand_block(ev){
	var temp=Snap(ev.target)
	var bin=temp.attr('starting')

	// manipulate blocks
	mobile.selectAll("[starting='"+bin+"'][ending]").forEach(function(step,i){
		if(parseInt(step.attr('starting'))!=parseInt(step.attr('ending'))){
			step.animate({opacity:1},400)
			if(parseInt(step.attr('starting'))<parseInt(step.attr('ending'))){
				var step_pos=step.attr('ending')-step.attr('starting')
				step.animate({y:parseFloat(step.attr('basey'))-5*step_pos},200,mina.easeinout,function(){step.animate({y:parseFloat(step.attr('basey'))},200,mina.easeinout)})
			} else if(parseInt(step.attr('starting'))>parseInt(step.attr('ending'))){
				var step_pos=step.attr('starting')-step.attr('ending')
				step.animate({y:parseFloat(step.attr('basey'))+5*step_pos},200,mina.easeinout,function(){step.animate({y:parseFloat(step.attr('basey'))},200,mina.easeinout)})
			}
		}
	})

	// write and fade-in text
	// toptext
	var percentchance=0
	for(var i=bin;i<10;i++){
		percentchance=percentchance+data['All'][type][bin][i]
	}

	if(bin!=10){
		var bintext=mobile.text(850,50,['People ','in ','the ',((bin-1)*10+'-'),(bin*10+'%'),' percentile ','of ','earnings ','have ','a ',percentchance.toFixed()+'% ','chance ']).attr({'font-size':22,'font-family':'Lato','text-anchor':'end',texttype:'temp',starting:bin,opacity:1})
		var bintext2=mobile.text(850,80,['of ','climbing ','into ','a ','higher income ','bracket ','15 ','years ','later.']).attr({'font-size':22,'font-family':'Lato','text-anchor':'end',texttype:'temp',starting:bin,opacity:1})
		bintext.selectAll("tspan").attr({opacity:0})
		bintext2.selectAll("tspan").attr({opacity:0})
	} else {
		var bintext=mobile.text(850,50,['People ','in ','the ','top 10% ','of ','the ','income']).attr({'font-size':22,'font-family':'Lato','text-anchor':'end',texttype:'temp',starting:bin,opacity:1})
		var bintext2=mobile.text(850,80,['distribution ','have ','nowhere ','to ','go ','but ','down.']).attr({'font-size':22,'font-family':'Lato','text-anchor':'end',texttype:'temp',starting:bin,opacity:1})
		bintext.selectAll("tspan").attr({opacity:0})
		bintext2.selectAll("tspan").attr({opacity:0})
	}

	setTimeout(function(){
		bintext.selectAll("tspan").forEach(function(word,i){
			setTimeout(function(){
				word.animate({opacity:1},700)
			},30*i)
		})
		
		bintext2.selectAll("tspan").forEach(function(word,i){
			setTimeout(function(){
				if(bin!=10 && i==4){
					word.attr({fill:'white','font-weight':700})
					var temprect=mobile.rect(490,57,145,30).attr({fill:color_scale[0],starting:bin,type:'temprect',opacity:0})
					temprect.animate({opacity:1},700)
					mobile.append(mobile.selectAll('text'))
				}
				if(bin==10 && i==6){
					word.attr({fill:'white','font-weight':700})
				}
				word.animate({opacity:1},700)
			},30*(i+5))
		})
	},100)

	// bottomtext
	var percentchance=0
	for(var i=bin-2;i>-1;i--){
		percentchance=percentchance+data['All'][type][bin][i]
	}

	if(bin!=1){
		var bintext3=mobile.text(50,620,['People ','in ','the ',((bin-1)*10+'-'),(bin*10+'%'),' percentile ','of ','earnings ','have ','a ',percentchance.toFixed()+'% ','chance ']).attr({'font-size':22,'font-family':'Lato','text-anchor':'start',texttype:'temp',starting:bin,opacity:1})
		var bintext4=mobile.text(50,650,['of ','falling ','into ','a ','lower income ','bracket ','15 ','years ','later.']).attr({'font-size':22,'font-family':'Lato','text-anchor':'start',texttype:'temp',starting:bin,opacity:1})
		bintext3.selectAll("tspan").attr({opacity:0})
		bintext4.selectAll("tspan").attr({opacity:0})
	} else {
		var bintext3=mobile.text(50,620,['People ','in ','the ','bottom 10% ','of ','the ','income']).attr({'font-size':22,'font-family':'Lato','text-anchor':'start',texttype:'temp',starting:bin,opacity:1})
		var bintext4=mobile.text(50,650,['distribution ','have ','nowhere ','to ','go ','but ','up.']).attr({'font-size':22,'font-family':'Lato','text-anchor':'start',texttype:'temp',starting:bin,opacity:1})
		bintext3.selectAll("tspan").attr({opacity:0})
		bintext4.selectAll("tspan").attr({opacity:0})
	}

	setTimeout(function(){
		bintext3.selectAll("tspan").forEach(function(word,i){
			setTimeout(function(){
				word.animate({opacity:1},700)
			},30*i)
		})
		
		bintext4.selectAll("tspan").forEach(function(word,i){
			setTimeout(function(){
				if(bin!=1 && i==4){word.attr({fill:color_scale[1],'font-weight':700})}
				if(bin==1 && i==6){word.attr({fill:color_scale[0],'font-weight':700})}
				word.animate({opacity:1},700)
			},30*(i+5))
		})
	},100)
}

function reduce_block(ev){
	var temp=Snap(ev.target)
	var bin=temp.attr('starting')
	mobile.selectAll("[starting='"+bin+"'][ending]").forEach(function(step,i){
		if(parseInt(step.attr('starting'))!=parseInt(step.attr('ending'))){
			step.stop()
			step.animate({opacity:.7},300)
			if(parseInt(step.attr('starting'))<parseInt(step.attr('ending'))){
				step.animate({y:parseFloat(step.attr('basey'))},200,mina.easeinout)
			} else if(parseInt(step.attr('starting'))>parseInt(step.attr('ending'))){
				step.animate({y:parseFloat(step.attr('basey'))},200,mina.easeinout)
			}
		}
	})

	mobile.selectAll("[starting='"+bin+"'][texttype]").forEach(function(word,i){
		word.stop()
	})
	mobile.selectAll("[starting='"+bin+"'][texttype]").animate({opacity:0},100)
	mobile.selectAll("[starting='"+bin+"'][type='temprect']").forEach(function(rect,i){
		// rect.stop()
		rect.animate({opacity:0},100,function(){rect.remove()})
	})
	
}













</script>